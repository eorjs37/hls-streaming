<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
	<script src="https://vjs.zencdn.net/8.3.0/video.min.js"></script>
	<title>Hls</title>
	<style>
		video {
			max-width: 500px;
			width: 100%;
			max-height: 500px;
			height: 100%;
			object-fit: fill;
		}
	</style>
</head>

<body>
	<video id="video" controls playsinline autoplay></video>

	<script>
		let video = null;
		let videoSrc = 'https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8'
		let hls = null;
		let callEventCount = 0;
		/* setVideo */
		const initVideo = () => {
			video = document.querySelector('#video')
		}

		/* playVideo */
		const playVideo = () => {
			console.log("call playVideo");
			const promise = video.play();
			if (promise !== undefined) {
				promise.then(_ => {
					// Autoplay started!
					console.log("success");
				}).catch(error => {
					// Autoplay was prevented.
					console.error("error : ", error);
					doPlayVideoRetry(3)
				});
			}
		}

		/* retry */
		const doPlayVideoRetry = (retryCount) => {
			return new Promise((resolve, reject) => {
				const retry = async (attempt) => {
					try {
						await video.play();

						resolve("작업이 완료되었습니다.");
					} catch (error) {
						console.error("error : ", error);
						if (attempt < retryCount) {
							console.error(`작업을 재시도 합니다. 남은 횟수 : ${retryCount - attempt}`);
							setTimeout(() => retry(attempt + 1), 1000)
						}
						else {
							reject(new Error('작업을 수행할 수 없습니다.'))
						}
					}
				}
				retry(0);
			})
		}

		/* promise retry video*/
		const videoPromiseRetry = (retryCount = 3) => {
			return new Promise((resolve, reject) => {

				const promise = video.play();
				promise.then(() => {
					resolve('videoPromiseRetry success')
				})
					.catch(error => {
						console.error("videoPromiseRetry error : ", error);
						reject(new Error('작업을 실패하였습니다.'))
					})
			})
		}


		/* eventHandle  */
		const eventHandle = (evt) => {
			const { type } = evt;

			switch (type) {
				case 'canplaythrough':
					console.log("canplaythrough");
					videoPromiseRetry()
						.then(result => {
							console.log(result);
						})
						.catch(err => {
							console.error("videoPromiseRetry error : ", err);
						})
					break;
				case 'canplay':
					console.log("canplay");
					break;
				case 'loadedmetadata':
					console.log('loadedmetadata');
					break;

				default:
					break;
			}
		}

		/* add video event */
		const videoAddEvent = () => {
			video.addEventListener("canplaythrough", eventHandle);
			video.addEventListener("canplay", eventHandle);
			video.addEventListener("loadedmetadata", eventHandle)
		}

		/* initHls */
		const initHls = () => {
			if (Hls.isSupported()) {
				hls = new Hls({
					autoStartLoad: false,
				});
				hls.loadSource(videoSrc);
				hls.attachMedia(video);

				hls.startLoad();
			}
			else {
				video.src = videoSrc;
			}
		}
		/* window load */
		window.addEventListener('load', () => {
			initVideo();
			initHls();
			videoAddEvent();
		})

	</script>
</body>

</html>